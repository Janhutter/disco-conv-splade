#!/bin/bash

#SBATCH --partition=gpu_a100
#SBATCH --gpus=1
#SBATCH --job-name=eval
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --time=1:00:00
#SBATCH --output=%A.out

set -e

seed=$1
dataset=$2
capitalized_dataset=${dataset^^}
model=$3
checkpoint_id=$4 

config=disco_${dataset}_${model}.yaml
base_dir=/scratch-shared/disco/disco_${capitalized_dataset}_${model}
index_dir=DATA/${dataset}_index_self/

# ----------------------------
# Choose checkpoint directory
# ----------------------------
if [ -n "$checkpoint_id" ]; then
    ckpt_dir=${base_dir}/checkpoint-${checkpoint_id}
    out_dir=/scratch-shared/disco/disco_${capitalized_dataset}_${model}_out_${seed}_ckpt${checkpoint_id}/
    echo "Using specified checkpoint: $ckpt_dir"
else
    ckpt_dir=${base_dir}/model
    out_dir=/scratch-shared/disco/disco_${capitalized_dataset}_${model}_out_${seed}/
    echo "No checkpoints found, falling back to model: $ckpt_dir"
    
fi

if [ ! -d "$ckpt_dir" ]; then
    echo "‚ùå Error: checkpoint directory not found: $ckpt_dir"
    exit 1
fi

# ----------------------------
# Run retrieval
# ----------------------------
python -m splade.retrieve \
    --config-name=$config \
    config.checkpoint_dir=$ckpt_dir \
    config.index_dir=$index_dir \
    config.out_dir=$out_dir \
    config.seed=$seed

